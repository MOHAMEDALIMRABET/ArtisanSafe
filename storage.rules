rules_version = '2';

// Firebase Storage Security Rules
// ArtisanSafe - Upload de documents (KBIS, Pièce d'identité)

service firebase.storage {
  match /b/{bucket}/o {
    
    // Règle par défaut: Deny all
    match /{allPaths=**} {
      allow read, write: if false;
    }
    
    // Photos des demandes de devis
    match /demandes/{userId}/{fileName} {
      // Lecture: Tout utilisateur authentifié peut lire les photos des demandes
      allow read: if request.auth != null;
      
      // Écriture: Seulement l'utilisateur propriétaire peut uploader ses photos
      allow write: if request.auth != null && 
                      request.auth.uid == userId &&
                      request.resource.size < 5 * 1024 * 1024 && // Max 5MB
                      request.resource.contentType.matches('image/(jpeg|jpg|png|gif|webp)');
    }
    
    // Documents des artisans
    match /artisans/{userId}/documents/{document} {
      // Lecture: L'utilisateur peut lire ses propres documents OU un admin
      allow read: if request.auth != null && 
                     (request.auth.uid == userId || 
                      get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin');
      
      // Écriture: Seulement l'utilisateur propriétaire peut uploader ses documents
      allow write: if request.auth != null && 
                      request.auth.uid == userId &&
                      request.resource.size < 5 * 1024 * 1024 && // Max 5MB
                      request.resource.contentType.matches('image/(jpeg|jpg|png)|application/pdf');
    }
    
    // Signatures électroniques des clients (acceptation devis)
    match /signatures/{signatureId} {
      // Lecture: Tout utilisateur authentifié peut lire les signatures
      // (Client doit voir sa signature, artisan doit voir signature du client)
      allow read: if request.auth != null;
      
      // Création: Seulement clients authentifiés peuvent créer des signatures
      allow create: if request.auth != null && 
                       request.auth.token.role == 'client' &&
                       request.resource.size < 5 * 1024 * 1024 && // Max 5MB
                       request.resource.contentType.matches('image/png');
      
      // Modification/Suppression: Interdit (signatures immuables)
      allow update, delete: if false;
    }
  }
}
