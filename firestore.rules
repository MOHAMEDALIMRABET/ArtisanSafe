rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // ============================================
    // FONCTIONS UTILITAIRES
    // ============================================
    
    function isAuthenticated() {
      return request.auth != null;
    }
    
    function isOwner(userId) {
      return isAuthenticated() && request.auth.uid == userId;
    }
    
    function hasRole(role) {
      return isAuthenticated() && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == role;
    }
    
    function isAdmin() {
      return hasRole('admin');
    }
    
    function isArtisan() {
      return hasRole('artisan');
    }
    
    function isClient() {
      return hasRole('client');
    }
    
    function isVerified() {
      return isAuthenticated() && 
        get(/databases/$(database)/documents/users/$(request.auth.uid)).data.statut == 'verifie';
    }
    
    // ============================================
    // 1. COLLECTION: users
    // ============================================
    // Accès privé uniquement par l'utilisateur authentifié
    // Admin peut tout lire
    
    match /users/{userId} {
      allow read: if isOwner(userId) || isAdmin();
      allow create: if isAuthenticated() && request.auth.uid == userId;
      allow update: if isOwner(userId) || isAdmin();
      allow delete: if isAdmin();
      
      // Validation des données
      allow write: if request.resource.data.keys().hasAll(['email', 'role', 'nom', 'prenom', 'telephone']) &&
                      request.resource.data.role in ['client', 'artisan', 'admin'] &&
                      request.resource.data.statut in ['non_verifie', 'verifie', 'suspendu'];
    }
    
    // ============================================
    // 2. COLLECTION: artisans
    // ============================================
    // Lecture publique pour permettre la recherche
    // Écriture uniquement par l'artisan propriétaire ou admin
    
    match /artisans/{artisanId} {
      allow read: if true; // Public pour recherche
      allow create: if isAuthenticated() && 
                       request.auth.uid == request.resource.data.userId &&
                       isArtisan();
      allow update: if (isAuthenticated() && request.auth.uid == resource.data.userId) || isAdmin();
      allow delete: if isAdmin();
    }
    
    // ============================================
    // 3. COLLECTION: demandes
    // ============================================
    // Client peut créer/modifier ses demandes
    // Artisans matchés peuvent lire
    // Admin peut tout lire
    
    match /demandes/{demandeId} {
      allow read: if isAdmin() ||
                     isOwner(resource.data.clientId) ||
                     (isAuthenticated() && request.auth.uid in resource.data.get('artisansMatches', []));
      allow create: if isAuthenticated() && 
                       request.auth.uid == request.resource.data.clientId;
      allow update: if isOwner(resource.data.clientId) || isAdmin();
      allow delete: if isOwner(resource.data.clientId) || isAdmin();
      
      // Validation statut
      allow write: if request.resource.data.statut in ['brouillon', 'publiee', 'matchee', 'en_cours', 'terminee', 'annulee'];
    }
    
    // ============================================
    // 4. COLLECTION: devis
    // ============================================
    // Client et artisan concernés peuvent lire
    // Artisan peut créer et modifier son devis
    // Client peut accepter/refuser
    
    match /devis/{devisId} {
      allow read: if isAdmin() ||
                     isOwner(resource.data.clientId) || 
                     isOwner(resource.data.artisanId);
      allow create: if isAuthenticated() && 
                       request.auth.uid == request.resource.data.artisanId &&
                       isArtisan();
      allow update: if isOwner(resource.data.artisanId) || 
                       isOwner(resource.data.clientId) ||
                       isAdmin();
      allow delete: if isOwner(resource.data.artisanId) || isAdmin();
      
      // Validation montants
      allow write: if request.resource.data.montantTTC > 0 &&
                      request.resource.data.statut in ['brouillon', 'envoye', 'accepte', 'refuse', 'expire'];
    }
    
    // ============================================
    // 5. COLLECTION: contrats
    // ============================================
    // Client et artisan concernés peuvent lire
    // Création après validation devis
    // Modification limitée selon statut
    
    match /contrats/{contratId} {
      allow read: if isAdmin() ||
                     isOwner(resource.data.clientId) || 
                     isOwner(resource.data.artisanId);
      allow create: if isAuthenticated() && 
                       (request.auth.uid == request.resource.data.clientId ||
                        request.auth.uid == request.resource.data.artisanId);
      allow update: if isOwner(resource.data.clientId) || 
                       isOwner(resource.data.artisanId) ||
                       isAdmin();
      allow delete: if isAdmin();
      
      // Validation commission 8%
      allow write: if request.resource.data.commission == request.resource.data.montantTTC * 0.08 &&
                      request.resource.data.montantArtisan == request.resource.data.montantTTC - request.resource.data.commission &&
                      request.resource.data.statut in ['signe', 'en_cours', 'termine', 'annule', 'litige'];
    }
    
    // ============================================
    // 6. COLLECTION: conversations
    // ============================================
    // Accès uniquement aux participants
    // Protection coordonnées avant contrat validé
    
    match /conversations/{conversationId} {
      allow read: if isAuthenticated() && 
                     request.auth.uid in resource.data.participants;
      allow create: if isAuthenticated() && 
                       request.auth.uid in request.resource.data.participants;
      allow update: if isAuthenticated() && 
                       request.auth.uid in resource.data.participants;
      allow delete: if isAdmin();
    }
    
    // ============================================
    // 7. COLLECTION: messages
    // ============================================
    // Lecture par participants de la conversation
    // Création uniquement si participant
    // Validation anti-spam coordonnées
    
    match /messages/{messageId} {
      allow read: if isAuthenticated();
      allow create: if isAuthenticated() &&
                       request.auth.uid == request.resource.data.senderId;
      allow update: if isOwner(resource.data.senderId) || isAdmin();
      allow delete: if isAdmin();
      
      // Protection coordonnées (regex basique)
      // Note: validation complète côté client/serveur
      allow write: if request.resource.data.type in ['texte', 'document', 'image'];
    }
    
    // ============================================
    // 8. COLLECTION: avis
    // ============================================
    // Lecture publique (affichage profils)
    // Création uniquement par client après chantier
    // 1 avis par contrat
    
    match /avis/{avisId} {
      allow read: if resource.data.visible == true || isAdmin() || isOwner(resource.data.artisanId);
      allow create: if isAuthenticated() && 
                       request.auth.uid == request.resource.data.clientId &&
                       isClient();
      allow update: if isOwner(resource.data.clientId) || 
                       isOwner(resource.data.artisanId) || // Peut répondre
                       isAdmin();
      allow delete: if isAdmin();
      
      // Validation note 1-5
      allow write: if request.resource.data.note >= 1 && 
                      request.resource.data.note <= 5;
    }
    
    // ============================================
    // 9. COLLECTION: litiges
    // ============================================
    // Client ou artisan peut créer litige sur son contrat
    // Admin gère la médiation
    
    match /litiges/{litigeId} {
      allow read: if isAdmin() ||
                     isOwner(resource.data.declarantId) ||
                     (resource.data.get('contratId', '') != '' && 
                      (isOwner(get(/databases/$(database)/documents/contrats/$(resource.data.contratId)).data.clientId) ||
                       isOwner(get(/databases/$(database)/documents/contrats/$(resource.data.contratId)).data.artisanId)));
      allow create: if isAuthenticated() && 
                       request.auth.uid == request.resource.data.declarantId;
      allow update: if isOwner(resource.data.declarantId) || isAdmin();
      allow delete: if isAdmin();
      
      // Validation motif
      allow write: if request.resource.data.motif in ['non_conformite', 'retard', 'abandon', 'qualite', 'paiement', 'autre'] &&
                      request.resource.data.statut in ['ouvert', 'en_mediation', 'resolu', 'clos'];
    }
    
    // ============================================
    // 10. COLLECTION: notifications
    // ============================================
    // Lecture uniquement par l'utilisateur concerné
    // Création par le système (via Functions)
    
    match /notifications/{notificationId} {
      allow read: if isOwner(resource.data.userId);
      allow create: if isAuthenticated(); // Via Cloud Functions
      allow update: if isOwner(resource.data.userId); // Marquer comme lu
      allow delete: if isOwner(resource.data.userId) || isAdmin();
    }
    
    // ============================================
    // 11. COLLECTION: transactions
    // ============================================
    // Lecture par client et artisan concernés
    // Création/modification uniquement par admin ou system (Stripe webhooks)
    
    match /transactions/{transactionId} {
      allow read: if isAdmin() ||
                     isOwner(resource.data.clientId) || 
                     isOwner(resource.data.artisanId);
      allow create: if isAdmin(); // Via Stripe webhooks
      allow update: if isAdmin(); // Mise à jour statut
      allow delete: if isAdmin();
      
      // Validation statut
      allow write: if request.resource.data.statut in ['pending', 'succeeded', 'failed', 'refunded'];
    }
  }
}
